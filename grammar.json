{
  "lex": {
    "rules": [
      ["$",                               "return 'EOF'"],
      ["--.*",                            "/* ignore comments */"],
      ["<[0-9A-Fa-f][0-9A-Fa-f](\\s+[0-9A-Fa-f][0-9A-Fa-f])*>", "return 'BUFFER'"],
      ["(null|true|false)\\b",            "return 'CONSTANT'"],
      ["return\\b",                       "return 'RETURN'"],
      ["abort\\b",                        "return 'ABORT'"],
      ["var\\b",                          "return 'VAR'"],
      ["for\\b",                          "return 'FOR'"],
      ["map\\b",                          "return 'MAP'"],
      ["in\\b",                           "return 'IN'"],
      ["if\\b",                           "return 'IF'"],
      ["elif\\b",                         "return 'ELIF'"],
      ["else\\b",                         "return 'ELSE'"],
      ["while\\b",                        "return 'WHILE'"],
      ["\\$[a-zA-Z_][a-zA-Z0-9_]*",       "return 'NATIVE_CODE'"],
      [":\"(?:[^\"\\\\]|\\\\.)*\"",       "return 'SSYMBOL'"],
      [":+[a-zA-Z_][a-zA-Z0-9_]*",        "return 'SYMBOL'"],
      ["@[a-zA-Z_][a-zA-Z0-9_]*",         "return 'FORM'"],
      ["\"(?:[^\"\\\\]|\\\\.)*\"",        "return 'STRING'"],
      ["'(?:[^'\\\\]|\\\\.)*'",           "return 'STRING'"],
      ["(?:0|-?[1-9][0-9]*):(?:0|-?[1-9][0-9]*)", "return 'RANGE'"],
      ["(?:0|-?[1-9][0-9]*):",            "return 'RANGE'"],
      [":(?:0|-?[1-9][0-9]*)",            "return 'RANGE'"],
      ["[a-zA-Z_][a-zA-Z0-9_]*",          "return 'IDENT'"],
      ["(?:0|-?[1-9][0-9]*)",             "return 'INTEGER'"],
      [":",                               "return ':'"],
      ["<<",                              "return '<<'"],
      [">>",                              "return '>>'"],
      ["(?:\\*|\\/|\\^|%)",               "return 'BINOP1'"],
      ["(?:\\+|-)",                       "return 'BINOP2'"],
      ["(?:<=|<|>=|>)",                   "return 'BINOP3'"],
      ["(?:!=|==)",                       "return 'BINOP4'"],
      ["(?:&&)",                          "return 'BINOP5'"],
      ["(?:\\|\\||\\^\\^)",               "return 'BINOP6'"],
      [",\\s*",                           "return ','"],
      ["\\s*\\.",                         "return '.'"],
      ["!",                               "return '!'"],
      ["=",                               "return '='"],
      ["\\[\\s*",                         "return '['"],
      ["\\s*\\]",                         "return ']'"],
      ["\\{\\s*",                         "return '{'"],
      ["\\|\\s*",                         "return '|'"],
      ["\\s*\\}",                         "return '}'"],
      ["\\(\\s*",                         "return '('"],
      ["\\s*\\)",                         "return ')'"],
      ["\\s*(?:\\r\\n|\\r|\\n|;)\\s*",    "return 'TERM'"],
      ["\\s+",                            "/* skip whitespace */"]
    ]
  },

  "operators": [
    ["left", ","],
    ["right", "="],
    ["left", "BINOP6"],
    ["left", "BINOP5"],
    ["left", "BINOP4"],
    ["left", "BINOP3"],
    ["left", "BINOP2"],
    ["left", "BINOP1"],
    ["right", "!"],
    ["left", ".", "[", "("]
  ],

  "bnf": {
    "root": [
      ["code EOF", "return $1"]
    ],
    "term0": ["", "term1"],
    "term1": ["TERM", "term1 TERM"],
    "code1": [
      ["expr", "$$ = [$1]"],
      ["statement", "$$ = [$1]"],
      ["code1 term1 expr", "$$ = $1.concat([$3])"],
      ["code1 term1 statement", "$$ = $1.concat([$3])"]
    ],
    "code": [
      ["term0", "$$ = []"],
      ["term0 code1 term0", "$$ = $2"]
    ],
    "list1": [
      ["expr", "$$ = [$1]"],
      ["list1 , expr", "$$ = $1.concat([$3])"]
    ],
    "list": [
      ["", "$$ = []"],
      ["list1", "$$ = $1"],
      ["list1 ,", "$$ = $1"]
    ],
    "params": [
      ["IDENT", "$$ = [$1]"],
      ["params , IDENT", "$$ = $1.concat([$2])"]
    ],
    "key": [
      ["IDENT :", "$$ = $1"],
      ["STRING :", "$$ = eval($1)"],
      ["[ expr ] :", "$$ = $2"]
    ],
    "pairs1": [
      ["key expr", "$$ = [$1, $2]"],
      ["pairs1 , key expr", "$$ = $1.concat([$3, $4])"]
    ],
    "pairs": [
      ["", "$$ = []"],
      ["pairs1", "$$ = $1"],
      ["pairs1 ,", "$$ = $1"]
    ],
    "elifs": [
      ["expr { code }", "$$ = [$1, $3]"],
      ["elifs ELIF expr { code }", "$$ = $1.concat([$3, $5])"]
    ],
    "chain": [
      ["IDENT . IDENT", "$$ = [$1, $2]"],
      ["IDENT [ expr ]", "$$ = [$1, $2]"],
      ["chain . IDENT", "$$ = $1.concat([$3])"],
      ["chain [ expr ]", "$$ = $1.concat([$3])"]
    ],
    "expr": [
      ["STRING", "$$ = eval($1);"],
      ["IDENT", "$$ = yy.Symbol($1)"],
      ["INTEGER", "$$ = parseInt($1, 10);"],
      ["CONSTANT", "$$ = $1 === 'true' ? true : $1 === 'false' ? false : null;"],
      ["BUFFER", "$$ = yy.Buffer($1.substr(1, $1.length - 2).split(/\\s+/).map(function (b) { return parseInt(b, 16);}))"],
      ["RANGE", "$$ = yy.Range($1);"],
      [":", "$$ = yy.Range($1);"],
      ["FORM", "$$ = yy.forms[$1.substr(1)];"],
      ["SSYMBOL", "$$ = yy.Symbol(':' + eval($1.substr(1)));"],
      ["SYMBOL", "$$ = yy.Symbol($1);"],
      ["NATIVE_CODE", "$$ = yy.NativeCode($1.substr(1));"],
      ["expr BINOP1 expr", "$$ = [yy.forms.call, $1, [$2, $3]]"],
      ["expr BINOP2 expr", "$$ = [yy.forms.call, $1, [$2, $3]]"],
      ["expr BINOP3 expr", "$$ = [yy.forms.call, $1, [$2, $3]]"],
      ["expr BINOP4 expr", "$$ = [yy.forms.call, $1, [$2, $3]]"],
      ["expr BINOP5 expr", "$$ = [yy.forms.call, $1, [$2, $3]]"],
      ["expr BINOP6 expr", "$$ = [yy.forms.call, $1, [$2, $3]]"],
      ["! expr", "$$ = [yy.forms.call, $2, [$1]]"],
      ["expr . IDENT", "$$ = [yy.forms.call, $1, ['get', $3]]"],
      ["expr [ expr ]", "$$ = [yy.forms.call, $1, ['get', $3]]"],
      ["expr . IDENT = expr", "$$ = [yy.forms.call, $1, ['set', $3, $5]]"],
      ["expr [ expr ] = expr", "$$ = [yy.forms.call, $1, ['set', $3, $6]]"],

      ["<< expr >>", "$$ = [yy.forms.buf, $2]"],
      ["{ params | code }", "$$ = [yy.forms.def, $2, $4]"],
      ["{ | code }", "$$ = [yy.forms.def, []].concat($3)"],
      ["[ list ]", "$$ = [yy.forms.array, $2]"],
      ["{ pairs }", "$$ = [yy.forms.object, $2]"],
      ["expr ( list )", "$$ = [yy.forms.call, $1, $3]"],
      ["( expr )", "$$ = $2"],

      ["VAR IDENT = expr", "$$ = [yy.forms.var, $2, $4]"],
      ["IDENT = expr", "$$ = [yy.forms.assign, $1, $3]"],
      ["MAP IDENT IN expr IF expr { code }", "$$ = [yy.forms.map, $2, $4, $6, $8]"],
      ["MAP IDENT IN expr { code }", "$$ = [yy.forms.map, $2, $4, true, $6]"],
      ["FOR IDENT IN expr IF expr { code }", "$$ = [yy.forms.for, $2, $4, $6, $8]"],
      ["FOR IDENT IN expr { code }", "$$ = [yy.forms.for, $2, $4, true, $6]"],
      ["IF elifs", "$$ = [yy.forms.if, $2]"],
      ["IF elifs ELSE { code }", "$$ = [yy.forms.if, $2, $5]"],
      ["WHILE expr { code }", "$$ = [yy.forms.while, $2, $4]"]
    ],
    "statement": [
      ["RETURN expr", "$$ = [yy.forms.return, $2]"],
      ["ABORT expr", "$$ = [yy.forms.abort, $2]"]
    ]
  }
}
